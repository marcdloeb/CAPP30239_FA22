---
title: "geojson_creation"
author: "Marc David Loeb"
date: '2022-11-04'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(sf)
library(tidyverse)
library(jsonlite)
```

Step 1: Converting csvs of race data and shapefiles of census tract boundaries into geojsons with standardized variable names

Census was inconsistent in 1920s-40s about how to count foreign born whites and non-black people of color. 


1920 tracts
```{r}
###1920s
tract_1920 <-st_read("data/sources/source_shapefiles/us_tract_1920/US_tract_1920_conflated.shp")
#st_crs(tract_1920)
#"ESRI 102003, USA_Contiguous_Albers_Equal_Area_Conic
#reprojecting to EPSG:3857, Web Mercator, which is what MapBox uses
tract_1920 <- st_transform(tract_1920, crs = "EPSG:3857")

#Selecting Cook County Tracts Only
tract_1920 <- tract_1920 %>% 
  select(GISJOIN, STATE, COUNTY, Shape_Area) %>%
  filter(STATE == "17", COUNTY == "031") %>%
  rename(land_area = Shape_Area,
         state = STATE,
         county = COUNTY)
  
#clean, everything adds up
race_1920 <-read.csv("data/sources/source_csvs/1920_tract.csv") %>% 
  select(-STATE, -STATEA, -COUNTY, -COUNTYA, -AREANAME, -PRETRACTA, -TRACTA, -POSTTRCTA) %>%
  rename(total_pop = A94001,
         nat_white_nat_par = BAT001,
         nat_white_for_par = BAT002,
         nat_white_mix_par = BAT003,
         for_white = BAT004,
         black = BAT005,
         other = BAT006,
         year = YEAR) %>%
  mutate(white = nat_white_nat_par
         +nat_white_for_par
         +nat_white_mix_par
         +for_white, 
         white_per = 100 * white/total_pop,
         black_per = 100 * black/total_pop)

#joining tracts and race data via census tract code
tract_1920 <- left_join(tract_1920, race_1920, by = "GISJOIN")

#plot(tract_1920 %>% select(black_per))
st_write(tract_1920, "data/working_data/1920_race_tract.geojson")
```

1930s tracts
```{r}
###1930s
tract_1930 <-st_read("data/sources/source_shapefiles/us_tract_1930/US_tract_1930_conflated.shp")
#st_crs(tract_1930)
#"ESRI 102003, USA_Contiguous_Albers_Equal_Area_Conic
#reprojecting to EPSG:3857, Web Mercator
tract_1930 <- st_transform(tract_1930, crs = "EPSG:3857")

#selecting cook county tracts only
tract_1930 <- tract_1930 %>% 
  select(GISJOIN, STATE, COUNTY, Shape_Area) %>%
  filter(STATE == "17", COUNTY == "031") %>%
  rename(land_area = Shape_Area,
         state = STATE,
         county = COUNTY)
#	G17003100318 has less than total pop
race_1930 <-read.csv("data/sources/source_csvs/1930_tract.csv") %>% 
  select(-STATE, -STATEA, -COUNTY, -COUNTYA, -AREANAME, -PRETRACTA, -TRACTA, -POSTTRCTA) %>%
  rename(total_pop = BHI001,
         nat_white_nat_par = BIQ001,
         nat_white_formix_par = BIQ002,
         for_white = BIQ003,
         black = BIQ004,
         other = BIQ005,
         year = YEAR) %>% 
  mutate(white = nat_white_nat_par
         +nat_white_formix_par
         +for_white, 
         white_per = 100 * white/total_pop,
         black_per = 100 * black/total_pop)
         #total_count = white + black + other,
         #total_per = total_count/total_pop)

tract_1930 <- left_join(tract_1930, race_1930, by = "GISJOIN")
plot(tract_1930 %>% select(black_per))
#st_write(tract_1930, "data/working_data/1930_race_tract.geojson")
```

1940s tracts
```{r}
###1940s
tract_1940 <-st_read("data/sources/source_shapefiles/us_tract_1940/US_tract_1940_conflated.shp")
st_crs(tract_1940)
#"ESRI 102003, USA_Contiguous_Albers_Equal_Area_Conic
#reprojecting to EPSG:3857, Web Mercator
tract_1940 <- st_transform(tract_1940, crs = "EPSG:3857")

#selecting cook county tracts only
tract_1940 <- tract_1940 %>% 
  select(GISJOIN, STATE, COUNTY, Shape_Area) %>%
  filter(STATE == "17", COUNTY == "031") %>%
  rename(land_area = Shape_Area,
         state = STATE,
         county = COUNTY)

#clean, everything adds up properly
race_1940 <-read.csv("data/sources/source_csvs/1940_tract.csv") %>%
  filter(STATEA == "17", COUNTYA == "31") %>%
  select(-STATE, -STATEA, -COUNTY, -COUNTYA, -AREANAME, -PRETRACTA, -TRACTA, -POSTTRCTA) %>%
  rename(total_pop = BUB001,
         white = BUQ001,
         nonwhite = BUQ002,
         black = BVG001,
         year = YEAR) %>%
  mutate(white_per = 100 * white/total_pop,
         black_per = 100 * black/total_pop)

tract_1940 <- left_join(tract_1940, race_1940, by = "GISJOIN")
#plot(tract_1940 %>% select(black_per))
st_write(tract_1940, "data/working_data/1940_race_tract.geojson")
```

1950s tracts
```{r}
###1950s
tract_1950 <-st_read("data/sources/source_shapefiles/us_tract_1950/US_tract_1950_conflated.shp")
st_crs(tract_1950)
#"ESRI 102003, USA_Contiguous_Albers_Equal_Area_Conic
#reprojecting to EPSG:3857, Web Mercator
tract_1950 <- st_transform(tract_1950, crs = "EPSG:3857")

#selecting cook county tracts only
tract_1950 <- tract_1950 %>% 
  select(GISJOIN, COUNTY, Shape_Area) %>%
  filter(COUNTY == "031") %>%
  #data is missing state column for some reason
  mutate(state = substr(GISJOIN, 2, 3)) %>%
  filter(state == "17") %>%
  rename(land_area = Shape_Area,
         county = COUNTY)

#clean
race_1950 <-read.csv("data/sources/source_csvs/1950_tract.csv") %>% 
  filter(STATEA == "17", COUNTYA == "31") %>%
  select(-STATE, -STATEA, -COUNTY, -COUNTYA, -AREANAME, -PRETRACTA, -TRACTA, -POSTTRCTA) %>%
  rename(total_pop = BZ8001,
         white = B0J001,
         black = B0J002,
         other_nonwhite = B0J003,
         year = YEAR) %>%
  mutate(white_per = 100 * white/total_pop,
         black_per = 100 * black/total_pop)
         #total_count =  white + black + other_nonwhite,
         #total_per = total_count/total_pop)

tract_1950 <- left_join(tract_1950, race_1950, by = "GISJOIN")
#plot(tract_1950 %>% select(black_per))
st_write(tract_1950, "data/working_data/1950_race_tract.geojson")
```

1960s tracts
```{r}
###1960s
tract_1960 <-st_read("data/sources/source_shapefiles/us_tract_1960/US_tract_1960_conflated.shp")
st_crs(tract_1960)
#"ESRI 102003, USA_Contiguous_Albers_Equal_Area_Conic
#reprojecting to EPSG:3857, Web Mercator
tract_1960 <- st_transform(tract_1960, crs = "EPSG:3857")

#selecting cook county tracts only
tract_1960 <- tract_1960 %>% 
  select(GISJOIN, STATE, COUNTY, Shape_Area) %>%
  filter(STATE == "17", COUNTY == "031") %>%
  rename(land_area = Shape_Area,
         state = STATE,
         county = COUNTY)

#lots of problems
# race_1960 <-read.csv("data/sources/source_csvs/1960_tract.csv") %>%
#   filter(STATEA == "17", COUNTYA == "31") %>%
#   rename(total_pop = CA4001,
#          white = B7B001,
#          black = B7B002,
#          other = B7B003,
#          year = YEAR) %>%
#   select(GISJOIN, total_pop, white, black, other, year) %>%
#   mutate(white_per = 100 * white/total_pop,
#          black_per = 100 * black/total_pop,
#          total_count = white + black + other,
#          total_per = total_count/total_pop)

#calculating total population from the columns themselves
race_1960 <-read.csv("data/sources/source_csvs/1960_tract.csv") %>%
  filter(STATEA == "17", COUNTYA == "31") %>%
  rename(white = B7B001,
         black = B7B002,
         other = B7B003,
         year = YEAR) %>%
  select(GISJOIN, white, black, other, year) %>%
  mutate(total_pop = white + black + other,
         white_per = 100 * white/total_pop,
         black_per = 100 * black/total_pop)

tract_1960 <- left_join(tract_1960, race_1960, by = "GISJOIN")
#plot(tract_1960 %>% select(black_per))
st_write(tract_1960, "data/working_data/1960_race_tract.geojson")
```

1970s tracts
```{r}
###1970s
tract_1970 <-st_read("data/sources/source_shapefiles/us_tract_1970/US_tract_1970_conflated.shp")
st_crs(tract_1970)
#"ESRI 102003, USA_Contiguous_Albers_Equal_Area_Conic
#reprojecting to EPSG:3857, Web Mercator
tract_1970 <- st_transform(tract_1970, crs = "EPSG:3857")

#selecting cook county tracts only
tract_1970 <- tract_1970 %>% 
  select(GISJOIN, COUNTY, Shape_Area) %>%
  filter(COUNTY == "031") %>%
  #data is missing state column for some reason
  mutate(state = substr(GISJOIN, 2, 3)) %>%
  filter(state == "17") %>%
  rename(land_area = Shape_Area,
         county = COUNTY)

#there are no tracts where the black population exceeds 100%
race_1970 <-read.csv("data/sources/source_csvs/1970_tract.csv") %>%
  filter(STATEA == "17", COUNTYA == "31") %>%
  rename(total_pop = CY7001,
         black = CY8001,
         year = YEAR) %>%
  select(GISJOIN, total_pop, black, year) %>%
  mutate(black_per = 100 * black/total_pop)
         #pop_diff = total_pop - black)

tract_1970 <- left_join(tract_1970, race_1970, by = "GISJOIN")
#plot(tract_1970 %>% select(black_per))
st_write(tract_1970, "data/working_data/1970_race_tract.geojson")
```

1980s tracts
```{r}
###1980s
tract_1980 <-st_read("data/sources/source_shapefiles/us_tract_1980/US_tract_1980_conflated.shp")
st_crs(tract_1980)
#"ESRI 102003, USA_Contiguous_Albers_Equal_Area_Conic
#reprojecting to EPSG:3857, Web Mercator
tract_1980 <- st_transform(tract_1980, crs = "EPSG:3857")

#selecting cook county tracts only
tract_1980 <- tract_1980 %>% 
  select(GISJOIN, COUNTY, Shape_Area) %>%
  filter(COUNTY == "031") %>%
  #data is missing state column for some reason
  mutate(state = substr(GISJOIN, 2, 3)) %>%
  filter(state == "17") %>%
  rename(land_area = Shape_Area,
         county = COUNTY)

#clean
race_1980 <-read.csv("data/sources/source_csvs/1980_tract.csv") %>%
  filter(STATEA == "17", COUNTYA == "31") %>%
  rename(total_pop = C6W001,
         white = C6X001,
         black = C6X002,
         native = C6X003,
         asian = C6X004,
         other = C6X005,
         year = YEAR) %>%
  select(GISJOIN, total_pop, white, black, native, asian, other, year) %>%
  mutate(white_per = 100 * white/total_pop,
         black_per = 100 * black/total_pop)
         #total_count = white + black + native + asian + other,
         #total_per = total_count/total_pop)

tract_1980 <- left_join(tract_1980, race_1980, by = "GISJOIN")
#plot(tract_1980 %>% select(black_per))
st_write(tract_1980, "data/working_data/1980_race_tract.geojson")
```


Step 2: Cleaning and filtering street address points
The street address point dataset that I created for my BA thesis includes more than 56,000 points, spread across much of the South Side. To limit the extent and improve the consistency of the data, I limit the street address to those that appear in the Daily Maroon, and are contained within a "study area" on the Southeast Side.

converting csv to sf object
```{r}
###Street Address Points
street_addr <-read.csv("data/sources/street_addresses/street_addr.csv")
#removing trailing whitespace
street_addr$publication <- trimws(street_addr$publication, which = c("both"))
street_addr$edition <- trimws(street_addr$edition, which = c("both"))
street_addr <- street_addr %>%
  rename(html_source = search_and_address,
         full_addr = full) %>%
  select(-old_search, -old_addr, -addr, -city_state)

street_addr_sf <- st_as_sf(street_addr, coords = c("lon", "lat"))
st_crs(street_addr_sf) = "EPSG:4326"
street_addr_sf <- st_transform(street_addr_sf, crs = "EPSG:3857")
st_write(street_addr_sf, "data/working_data/all_uncleaned_street_addr.geojson")
```

Removing duplicates
need to search multiple permutations of the same address eg "6311 COTTAGE GROVE" and "6311 South COTTAGE GROVE" means that duplicates occasionally exist reduces number of observations from 56608 to 56172
```{r}
street_addr_clean <- street_addr %>% 
  group_by(full_addr, publication, edition, day, month, year, geoaddress, lat, lon) %>% 
  summarise(quantity = max(quantity))
street_addr_clean <- street_addr_clean %>% ungroup()
str_addr_sf_clean <- st_as_sf(street_addr_clean, coords = c("lon", "lat"))
#internet said that this was supposed to be "EPSG:3857"! Took me like an hour to trial and error
st_crs(str_addr_sf_clean) = "EPSG:4326"
str_addr_sf_clean <- st_transform(str_addr_sf_clean, crs = "EPSG:3857")
st_write(str_addr_sf_clean , "data/working_data/all_cleaned_street_addr.geojson")
```

Old cleaning code
```{r}
### Address searches with slight semantic differences catch the same peice of text
### eg "6311 COTTAGE GROVE" and "6311 South COTTAGE GROVE"
# street_addr_preserved_searches <- street_addr %>% 
#   group_by(full_addr, publication, edition, day, month, year, geoaddress) %>% 
#   summarise(quantity = max(quantity), 
#             searches = list(unique(search)))
# 
# street_addr_preserved_searches %>%
#   ungroup %>%
#   unnest(cols = c(searches))
# 
# for (search_list in street_addr_preserved_searches$searches) {
#   if (length(search_list) >1) {
#     print(search_list)
#   }
# }
```

Limiting to just those from Maroon articles
```{r}
#str_addr_sf_clean <- st_read("data/working_data/all_cleaned_street_addr.geojson")
str_addr_sf_maroon <- str_addr_sf_clean %>% 
  filter(publication == "Daily Maroon") %>%
  #no edition data for Maroon anyways
  select(-edition)
#st_write(str_addr_sf_maroon, "data/working_data/maroon_street_addr.geojson")
```

Step 3: Assigning neighborhood labels to street address points and census tract polygons

loading in neighborhood polygons
polygons created by hand in QGIS
```{r}
chicago_polys <-st_read("data/working_data/chicago_polys_for_addr.geojson")
study_area <- chicago_polys[chicago_polys$name == "study_area",]
neighborhoods <- chicago_polys[chicago_polys$name != "study_area",]
```

assigning polygons to points
```{r}
str_addr_sf_maroon <- st_read("data/working_data/maroon_street_addr.geojson")
#hacky way of doing an intersection that is faster that st_intersection, and avoids the attribute join
str_addr_sf_nb <- str_addr_sf_maroon[st_intersects(str_addr_sf_maroon, study_area) %>% lengths > 0,]
str_addr_sf_nb <- st_join(str_addr_sf_nb, neighborhoods %>% select(-id))
str_addr_sf_nb <- str_addr_sf_nb %>% rename(neighborhood = name)
#wrong!
str_addr_sf_nb$neighborhood[is.na(str_addr_sf_nb$neighborhood)] = "other_within_study_area"


```

adding decades
```{r}
#adding decades
str_addr_sf_nb <- str_addr_sf_nb %>%   
  mutate(decade = ifelse(year <= 1914, "1902-1914",
                  ifelse(year <= 1925, "1915-1925",
                  ifelse(year <= 1935, "1926-1935",
                  ifelse(year <= 1945, "1936-1945",
                  ifelse(year <= 1955, "1946-1955",       
                  ifelse(year <= 1965, "1956-1965",
                  ifelse(year <= 1975, "1966-1975",
                  ifelse(year <= 1986, "1976-1986","Other")
  ))))))))

st_write(str_addr_sf_nb, "data/map_data/nbhood_street_addr.geojson")
```

Finding the absolute number of addresses in each neighborhood
```{r}
str_addr_sf_nb <- st_read("data/map_data/nbhood_street_addr.geojson")

### count by neighborhood
str_addr_sf_nb_counts <- str_addr_sf_nb %>% 
  #filter(!is.na(neighborhood)) %>%
  group_by(neighborhood) %>% 
  summarize(count = sum(quantity))
#st_write(str_addr_sf_nb_counts, "data/working_data/nbhood_street_addr_counts.geojson")

#csv version
str_addr_nb_counts <- str_addr_sf_nb_counts %>%
  st_drop_geometry() %>%
  column_to_rownames("neighborhood")
#write.csv(str_addr_nb_counts, "data/working_data/nbhood_street_addr_counts.csv")

```

Street address count by year
```{r}
### finding count by year
str_addr_sf_nbyear_counts <- str_addr_sf_nb %>% 
  #filter(!is.na(neighborhood)) %>%
  group_by(neighborhood, year) %>% 
  summarize(count = sum(quantity))
#st_write(str_addr_sf_nbyear_counts, "data/working_data/nbhood_year_street_addr_counts.geojson")

### pivoting data so that neighborhood is on the y axis and year is on the x
str_addr_nbyear_counts_pivot <- str_addr_sf_nbyear_counts %>% 
  st_drop_geometry() %>%
  pivot_wider(names_from = year,values_from = count)

str_addr_nbyear_counts_pivot <- str_addr_nbyear_counts_pivot[,order(names(str_addr_nbyear_counts_pivot))]
str_addr_nbyear_counts_pivot <- str_addr_nbyear_counts_pivot %>% mutate_all(~replace_na(., 0))
#1972 is mostly missing its data, removing the column
str_addr_nbyear_counts_pivot <- str_addr_nbyear_counts_pivot %>% select(-"1972")
write.csv(str_addr_nbyear_counts_pivot, "data/chart_data/nbhood_year_street_addr_counts.csv")
```

Street address proportion in each neighborhood each year
```{r}
### finding percentage of total in each neighborhood in each year
# https://stackoverflow.com/questions/9447801/dividing-columns-by-colsums-in-r
str_addr_nbyear_prop <- 100 * sweep(str_addr_nbyear_counts_pivot,2,colSums(str_addr_nbyear_counts_pivot),`/`)
#write.csv(str_addr_nbyear_prop, "data/chart_data/nbhood_year_street_addr_perc.csv")

```

Street address counts per decades by neighborhood
```{r}
str_addr_sf_nbyear_counts <- st_read("data/working_data/nbhood_year_street_addr_counts.geojson")
str_addr_sf_nb_decade <- str_addr_sf_nbyear_counts %>% 
  mutate(decade = ifelse(year <= 1914, "1902-1914",
                  ifelse(year <= 1925, "1915-1925",
                  ifelse(year <= 1935, "1926-1935",
                  ifelse(year <= 1945, "1936-1945",
                  ifelse(year <= 1955, "1946-1955",       
                  ifelse(year <= 1965, "1956-1965",
                  ifelse(year <= 1975, "1966-1975",
                  ifelse(year <= 1986, "1976-1986","Other")
  ))))))))

str_addr_sf_nb_decade_grouped <- str_addr_sf_nb_decade %>% 
  #filter(!is.na(neighborhood)) %>%
  group_by(neighborhood, decade) %>% 
  summarize(count = sum(count))
#st_write(str_addr_sf_nb_decade_grouped, "")

str_addr_nb_decade_grouped <- str_addr_sf_nb_decade_grouped %>% st_drop_geometry()
write.csv(str_addr_nb_decade_grouped, "data/chart_data/nbhood_decade_street_addr_counts.csv")
```


Street address proportions per decades by neighborhood




limiting tracts to the study area, and assigning neighborhood labels
```{r}
chicago_polys <-st_read("data/working_data/chicago_polys_for_tracts.geojson")
neighborhoods <- chicago_polys[chicago_polys$name != "study_area",]
study_area <- chicago_polys[chicago_polys$name == "study_area",]
```

1920 requires a bit of manual cleaning to remove a north kenwood duplicate
```{r}
tract_1920 <- st_read("data/working_data/1920_race_tract.geojson")
tract_1920_study_area <- tract_1920 %>% st_filter(y = study_area, .predicate = st_intersects)
tract_1920_study_area <- st_join(tract_1920_study_area, neighborhoods %>% select(-id))
tract_1920_study_area <- tract_1920_study_area %>% 
  rename(neighborhood = name)
tract_1920_study_area$neighborhood[is.na(tract_1920_study_area$neighborhood)] = "other_within_study_area"
plot(tract_1920_study_area %>% select(neighborhood))
st_write(tract_1920_study_area, "data/map_data/1920_race_tract_nb.geojson")
```

```{r}
tract_1930 <- st_read("data/working_data/1930_race_tract.geojson")
tract_1930_study_area <- tract_1930 %>% st_filter(y = study_area, .predicate = st_intersects)
tract_1930_study_area <- st_join(tract_1930_study_area, neighborhoods %>% select(-id))
tract_1930_study_area <- tract_1930_study_area %>% 
  rename(neighborhood = name)
tract_1930_study_area$neighborhood[is.na(tract_1930_study_area$neighborhood)] = "other_within_study_area"
plot(tract_1930_study_area %>% select(neighborhood))
st_write(tract_1930_study_area, "data/map_data/1930_race_tract_nb.geojson")
```

```{r}
tract_1940 <- st_read("data/working_data/1940_race_tract.geojson")
tract_1940_study_area <- tract_1940 %>% st_filter(y = study_area, .predicate = st_intersects)
tract_1940_study_area <- st_join(tract_1940_study_area, neighborhoods %>% select(-id))
tract_1940_study_area <- tract_1940_study_area %>% 
  rename(neighborhood = name)
tract_1940_study_area$neighborhood[is.na(tract_1940_study_area$neighborhood)] = "other_within_study_area"
plot(tract_1940_study_area %>% select(neighborhood))
st_write(tract_1940_study_area, "data/map_data/1940_race_tract_nb.geojson")
```

```{r}
tract_1950 <- st_read("data/working_data/1950_race_tract.geojson")
tract_1950_study_area <- tract_1950 %>% st_filter(y = study_area, .predicate = st_intersects)
tract_1950_study_area <- st_join(tract_1950_study_area, neighborhoods %>% select(-id))
tract_1950_study_area <- tract_1950_study_area %>% 
  rename(neighborhood = name)
tract_1950_study_area$neighborhood[is.na(tract_1950_study_area$neighborhood)] = "other_within_study_area"
plot(tract_1950_study_area %>% select(neighborhood))
st_write(tract_1950_study_area, "data/map_data/1950_race_tract_nb.geojson")
```

```{r}
tract_1960 <- st_read("data/working_data/1960_race_tract.geojson")
tract_1960_study_area <- tract_1960 %>% st_filter(y = study_area, .predicate = st_intersects)
tract_1960_study_area <- st_join(tract_1960_study_area, neighborhoods %>% select(-id))
tract_1960_study_area <- tract_1960_study_area %>% 
  rename(neighborhood = name)
tract_1960_study_area$neighborhood[is.na(tract_1960_study_area$neighborhood)] = "other_within_study_area"
plot(tract_1960_study_area %>% select(neighborhood))
st_write(tract_1960_study_area, "data/map_data/1960_race_tract_nb.geojson")
```

```{r}
tract_1970 <- st_read("data/working_data/1970_race_tract.geojson")
tract_1970_study_area <- tract_1970 %>% st_filter(y = study_area, .predicate = st_intersects)
tract_1970_study_area <- st_join(tract_1970_study_area, neighborhoods %>% select(-id))
tract_1970_study_area <- tract_1970_study_area %>% 
  rename(neighborhood = name)
tract_1970_study_area$neighborhood[is.na(tract_1970_study_area$neighborhood)] = "other_within_study_area"
plot(tract_1970_study_area %>% select(neighborhood))
st_write(tract_1970_study_area, "data/map_data/1970_race_tract_nb.geojson")
```

```{r}
tract_1980 <- st_read("data/working_data/1980_race_tract.geojson")
tract_1980_study_area <- tract_1980 %>% st_filter(y = study_area, .predicate = st_intersects)
tract_1980_study_area <- st_join(tract_1980_study_area, neighborhoods %>% select(-id))
tract_1980_study_area <- tract_1980_study_area %>% 
  rename(neighborhood = name)
tract_1980_study_area$neighborhood[is.na(tract_1980_study_area$neighborhood)] = "other_within_study_area"
plot(tract_1980_study_area %>% select(neighborhood))
st_write(tract_1980_study_area, "data/map_data/1980_race_tract_nb.geojson")
```

Step 4: Find Black population share of each neighborhood

```{r}
tract_1920_nb <- st_read("data/map_data/1920_race_tract_nb.geojson")
tract_1920_grouped <- tract_1920_nb %>%
  group_by(neighborhood) %>%
  summarize(black_per = sum(black)/sum(total_pop))
plot(tract_1920_grouped %>%select(black_per))
st_write(tract_1920_grouped, "data/working_data/1920_race_tract_grouped.geojson")
```

```{r}
tract_1930_nb <- st_read("data/map_data/1930_race_tract_nb.geojson")
tract_1930_grouped <- tract_1930_nb %>%
  group_by(neighborhood) %>%
  summarize(black_per = sum(black)/sum(total_pop))
plot(tract_1930_grouped %>%select(black_per))
st_write(tract_1930_grouped, "data/working_data/1930_race_tract_grouped.geojson")
```

```{r}
tract_1940_nb <- st_read("data/map_data/1940_race_tract_nb.geojson")
tract_1940_grouped <- tract_1940_nb %>%
  group_by(neighborhood) %>%
  summarize(black_per = sum(black)/sum(total_pop))
plot(tract_1940_grouped %>%select(black_per))
st_write(tract_1940_grouped, "data/working_data/1940_race_tract_grouped.geojson")
```

```{r}
tract_1950_nb <- st_read("data/map_data/1950_race_tract_nb.geojson")
tract_1950_grouped <- tract_1950_nb %>%
  group_by(neighborhood) %>%
  summarize(black_per = sum(black)/sum(total_pop))
plot(tract_1950_grouped %>%select(black_per))
st_write(tract_1950_grouped, "data/working_data/1950_race_tract_grouped.geojson")
```

```{r}
tract_1960_nb <- st_read("data/map_data/1960_race_tract_nb.geojson")
tract_1960_grouped <- tract_1960_nb %>%
  group_by(neighborhood) %>%
  summarize(black_per = sum(black)/sum(total_pop))
plot(tract_1960_grouped %>%select(black_per))
st_write(tract_1960_grouped, "data/working_data/1960_race_tract_grouped.geojson")
```

```{r}
tract_1970_nb <- st_read("data/map_data/1970_race_tract_nb.geojson")
tract_1970_grouped <- tract_1970_nb %>%
  group_by(neighborhood) %>%
  summarize(black_per = sum(black)/sum(total_pop))
plot(tract_1970_grouped %>%select(black_per))
st_write(tract_1970_grouped, "data/working_data/1970_race_tract_grouped.geojson")
```

```{r}
tract_1980_nb <- st_read("data/map_data/1980_race_tract_nb.geojson")
tract_1980_grouped <- tract_1980_nb %>%
  group_by(neighborhood) %>%
  summarize(black_per = sum(black)/sum(total_pop))
plot(tract_1980_grouped %>%select(black_per))
st_write(tract_1980_grouped, "data/working_data/1980_race_tract_grouped.geojson")

```

Combining each decades black percentage by neighborhood

```{r}
all_nb_blackper <- data.frame(neighborhood = tract_1920_grouped$neighborhood,
                     blackper_1920 = tract_1920_grouped$black_per,
                     blackper_1930 = tract_1930_grouped$black_per,
                     blackper_1940 = tract_1940_grouped$black_per,
                     blackper_1950 = tract_1950_grouped$black_per,
                     blackper_1960 = tract_1960_grouped$black_per,
                     blackper_1970 = tract_1970_grouped$black_per,
                     blackper_1980 = tract_1980_grouped$black_per)

write.csv(all_nb_blackper, "data/chart_data/all_nb_blackper.csv")
```

Writing JSON version
```{r}
all_nb_blackper <- read.csv("data/chart_data/all_nb_blackper.csv")
all_nb_blackper_json <- toJSON(x = all_nb_blackper, dataframe = 'rows', pretty = T)
write_json(all_nb_blackper_json, "data/chart_data/all_nb_blackper.json")
```



